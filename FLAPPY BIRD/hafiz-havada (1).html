<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HafÄ±z Havada â€” Ramazan Ã–zel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN TOKENS â€” ISLAMIC RAMADAN PALETTE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            /* Deep jewel-tone backgrounds */
            --ink:           #0A0F1E;
            --panel-bg-1:    #0D1B2A;
            --panel-bg-2:    #0B2240;
            --panel-bg-3:    #071526;

            /* Gold spectrum */
            --gold-bright:   #FFD700;
            --gold-mid:      #F0A500;
            --gold-warm:     #C8860A;
            --gold-dark:     #7A4F00;
            --gold-glow:     rgba(255, 215, 0, 0.50);
            --gold-glow-soft:rgba(255, 215, 0, 0.15);

            /* Emerald accent */
            --emerald:       #1A6B4A;
            --emerald-light: #26A96C;

            /* Text */
            --cream:         #FFF8DC;
            --parchment:     #F5DEB3;
            --text-muted:    rgba(255,220,120,0.55);

            /* Alerts */
            --red-alert:     #FF4444;

            /* Shadows */
            --shadow-deep:   rgba(0,0,0,0.85);
            --shadow-mid:    rgba(0,0,0,0.50);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET & BASE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--ink);
            font-family: 'Fredoka', sans-serif;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GAME CANVAS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #gameCanvas {
            display: block;
            position: fixed;
            top: 0; left: 0;
            z-index: 1;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOADING SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #loader {
            position: fixed;
            inset: 0;
            z-index: 999;
            background:
                radial-gradient(ellipse at 50% 40%, #0d2a4a 0%, #060d18 70%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
            transition: opacity 0.5s ease;
        }

        #loader.fade-out { opacity: 0; pointer-events: none; }

        .loader-star {
            font-size: 56px;
            animation: spinGlow 2s linear infinite;
            filter: drop-shadow(0 0 12px var(--gold-bright));
        }

        .loader-text {
            color: var(--gold-bright);
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 4px;
            text-transform: uppercase;
            animation: pulse 1s ease-in-out infinite alternate;
        }

        .loader-bar-track {
            width: 220px;
            height: 6px;
            background: rgba(255,255,255,0.08);
            border-radius: 99px;
            overflow: hidden;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .loader-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--gold-warm), var(--gold-bright));
            border-radius: 99px;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px var(--gold-bright);
        }

        @keyframes spinGlow {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            from { opacity: 0.5; }
            to   { opacity: 1.0; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50%       { transform: translateY(-6px); }
        }
        @keyframes goldShimmer {
            0%   { background-position: -200% center; }
            100% { background-position:  200% center; }
        }
        @keyframes panelReveal {
            from { opacity: 0; transform: scale(0.88) translateY(20px); }
            to   { opacity: 1; transform: scale(1)    translateY(0); }
        }
        @keyframes borderPulse {
            0%, 100% { box-shadow:
                0 0 0 1px var(--gold-dark),
                0 0 0 3px var(--panel-bg-3),
                0 0 0 5px var(--gold-warm),
                0 0 30px var(--gold-glow),
                0 0 80px var(--gold-glow-soft),
                inset 0 0 60px rgba(0,0,0,0.6);
            }
            50% { box-shadow:
                0 0 0 1px var(--gold-dark),
                0 0 0 3px var(--panel-bg-3),
                0 0 0 5px var(--gold-bright),
                0 0 45px var(--gold-glow),
                0 0 100px rgba(255,215,0,0.25),
                inset 0 0 60px rgba(0,0,0,0.6);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HUD â€” LIVE SCORE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #hud-score {
            position: fixed;
            top: 9%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            font-size: 64px;
            font-weight: 600;
            color: #fff;
            text-shadow:
                 2px  2px 0 #000,
                -2px -2px 0 #000,
                 2px -2px 0 #000,
                -2px  2px 0 #000,
                 3px  0   0 #000,
                -3px  0   0 #000,
                 0    3px 0 #000,
                 0   -3px 0 #000;
            pointer-events: none;
            display: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           OVERLAY BACKDROP
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .panel-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(4, 10, 22, 0.72);
            backdrop-filter: blur(4px) saturate(0.8);
        }
        .panel-overlay.hidden { display: none; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RAMADAN PANEL â€” THE ISLAMIC ARCH FRAME
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .ramadan-panel {
            position: relative;
            width: 92vw;
            max-width: 400px;
            text-align: center;
            padding: 0 0 36px;

            /* Deep midnight-blue body with subtle geometric tiling */
            background:
                /* Arabesque star lattice â€” 8-pt star via layered gradients */
                repeating-conic-gradient(
                    from 0deg at 50% 50%,
                    rgba(255,215,0,0.028) 0deg 45deg,
                    transparent 45deg 90deg
                ),
                repeating-linear-gradient(
                    45deg,
                    rgba(255,215,0,0.018) 0px, rgba(255,215,0,0.018) 1px,
                    transparent 1px, transparent 28px
                ),
                repeating-linear-gradient(
                    -45deg,
                    rgba(255,215,0,0.018) 0px, rgba(255,215,0,0.018) 1px,
                    transparent 1px, transparent 28px
                ),
                /* Radial depth â€” lighter at top center, dark at edges */
                radial-gradient(ellipse at 50% 0%,
                    #163354 0%,
                    #0D1F38 40%,
                    #071220 100%
                );

            /* Double gold border: thin bright outer, gap (panel bg), thicker warm inner */
            border: 2px solid var(--gold-bright);
            outline: 5px solid var(--panel-bg-3);
            outline-offset: -7px;

            border-radius: 18px 18px 14px 14px;

            /* Animated glow */
            box-shadow:
                0 0 0 1px var(--gold-dark),
                0 0 0 3px var(--panel-bg-3),
                0 0 0 5px var(--gold-warm),
                0 0 30px var(--gold-glow),
                0 0 80px var(--gold-glow-soft),
                inset 0 0 60px rgba(0,0,0,0.6);
            animation:
                panelReveal 0.42s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards,
                borderPulse 3s ease-in-out 0.5s infinite;
        }

        /* â”€â”€ Islamic Arch Header Band â”€â”€ */
        .ramadan-panel .arch-header {
            position: relative;
            background: linear-gradient(160deg,
                #1a3a5c 0%,
                #0e2340 50%,
                #0a1829 100%
            );
            border-bottom: 2px solid var(--gold-warm);
            border-radius: 16px 16px 0 0;
            padding: 22px 24px 18px;
            /* Top edge gold bar */
            box-shadow:
                inset 0 1px 0 rgba(255,215,0,0.3),
                0 4px 12px rgba(0,0,0,0.5);
        }

        /* Corner diamond ornaments (pure CSS) */
        .ramadan-panel .arch-header::before,
        .ramadan-panel .arch-header::after {
            content: 'â—†';
            position: absolute;
            top: 14px;
            font-size: 13px;
            color: var(--gold-warm);
            opacity: 0.75;
            text-shadow: 0 0 8px var(--gold-bright);
        }
        .ramadan-panel .arch-header::before { left: 14px; }
        .ramadan-panel .arch-header::after  { right: 14px; }

        /* â”€â”€ Crescent Icon â”€â”€ */
        .panel-icon {
            font-size: 42px;
            line-height: 1;
            filter: drop-shadow(0 0 10px var(--gold-bright))
                    drop-shadow(0 2px 4px rgba(0,0,0,0.8));
            animation: float 3s ease-in-out infinite;
            display: block;
            margin-bottom: 6px;
        }

        /* â”€â”€ Panel Title â”€â”€ */
        .panel-title {
            font-size: 44px;
            font-weight: 600;
            letter-spacing: 1.5px;
            line-height: 1.1;
            margin-bottom: 2px;
            /* Shimmer gradient text */
            background: linear-gradient(
                90deg,
                var(--gold-dark)    0%,
                var(--gold-bright)  25%,
                #fff8c0             50%,
                var(--gold-bright)  75%,
                var(--gold-dark)   100%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: goldShimmer 3.5s linear infinite;
        }
        .panel-title.danger {
            background: linear-gradient(90deg, #ff6b6b, #ff0000, #ff6b6b);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: goldShimmer 2.5s linear infinite;
        }

        .panel-subtitle {
            font-size: 15px;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* â”€â”€ Ornamental Divider â”€â”€ */
        .panel-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 28px 0;
        }
        .panel-divider::before,
        .panel-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold-warm));
        }
        .panel-divider::after {
            background: linear-gradient(90deg, var(--gold-warm), transparent);
        }
        .panel-divider span {
            color: var(--gold-bright);
            font-size: 16px;
            line-height: 1;
            filter: drop-shadow(0 0 6px var(--gold-bright));
        }

        /* â”€â”€ Body (below arch header) â”€â”€ */
        .ramadan-panel .panel-body {
            padding: 24px 28px 0;
        }

        /* â”€â”€ Stat Boxes (Parchment Scrolls) â”€â”€ */
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin-bottom: 26px;
        }

        .stat-box {
            flex: 1;
            position: relative;
            background:
                linear-gradient(160deg, #1c2e42 0%, #0f1e2e 100%);
            border: 1px solid var(--gold-warm);
            border-radius: 10px;
            padding: 14px 12px 12px;
            /* Inset engraving effect */
            box-shadow:
                inset 0 2px 8px rgba(0,0,0,0.6),
                inset 0 1px 0 rgba(255,215,0,0.08),
                0 1px 0 rgba(255,215,0,0.15);
        }
        /* Tiny corner notches */
        .stat-box::before {
            content: '';
            position: absolute;
            inset: 3px;
            border: 1px solid rgba(255,215,0,0.1);
            border-radius: 7px;
            pointer-events: none;
        }

        .stat-label {
            color: var(--gold-warm);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        .stat-value {
            color: #fff;
            font-size: 36px;
            font-weight: 600;
            line-height: 1;
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
        }
        .stat-value.gold {
            background: linear-gradient(180deg, #fff8a0 0%, var(--gold-bright) 60%, var(--gold-warm) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 6px rgba(255,215,0,0.5));
        }

        /* â”€â”€ Golden Bar Button â”€â”€ */
        .btn-gold {
            display: inline-block;
            position: relative;
            background: linear-gradient(
                180deg,
                #fff3a0 0%,
                #ffd700 20%,
                #e8a000 60%,
                #b87800 85%,
                #8a5c00 100%
            );
            border: none;
            border-radius: 8px;
            padding: 0;
            width: 85%;
            cursor: pointer;
            -webkit-appearance: none;
            /* 3D base shadow */
            box-shadow:
                0 6px 0 #5a3800,
                0 8px 20px rgba(0,0,0,0.6),
                inset 0 1px 0 rgba(255,255,220,0.5);
            transition: transform 0.08s, box-shadow 0.08s;
        }
        .btn-gold::before {
            /* Engraved inner stroke */
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,200,0.25);
            pointer-events: none;
        }
        .btn-gold span {
            display: block;
            padding: 13px 32px;
            font-family: 'Fredoka', sans-serif;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #2C1600;
            text-shadow: 0 1px 0 rgba(255,255,180,0.6);
        }
        .btn-gold:hover {
            background: linear-gradient(
                180deg,
                #fffac8 0%,
                #ffe433 20%,
                #f0b800 60%,
                #c08800 85%,
                #9a6a00 100%
            );
            box-shadow:
                0 6px 0 #5a3800,
                0 10px 28px rgba(255,215,0,0.35),
                inset 0 1px 0 rgba(255,255,220,0.5);
        }
        .btn-gold:active {
            transform: translateY(5px);
            box-shadow:
                0 1px 0 #5a3800,
                0 3px 8px rgba(0,0,0,0.4);
        }

        /* Utility */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="loader">
        <div class="loader-star">â˜ª</div>
        <div class="loader-text">YÃœKLENÄ°YOR</div>
        <div class="loader-bar-track">
            <div class="loader-bar-fill" id="loader-bar"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME CANVAS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <canvas id="gameCanvas"></canvas>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• HUD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="hud-score">0</div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="screen-menu" class="panel-overlay">
        <div class="ramadan-panel">
            <div class="arch-header">
                <span class="panel-icon">â˜ª</span>
                <div class="panel-title">HAFIZ HAVADA</div>
                <div class="panel-subtitle">âœ¦ Ramazan Ã–zel âœ¦</div>
            </div>
            <div class="panel-body">
                <div class="panel-divider"><span>âœ¦</span></div>
                <button class="btn-gold" id="btn-start"><span>BAÅLA</span></button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME OVER SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="screen-gameover" class="panel-overlay hidden">
        <div class="ramadan-panel">
            <div class="arch-header">
                <span class="panel-icon">ğŸ®</span>
                <div class="panel-title danger">OYUN BÄ°TTÄ°</div>
                <div class="panel-subtitle">âœ¦ Tekrar dene âœ¦</div>
            </div>
            <div class="panel-body">
                <div class="panel-divider"><span>âœ¦</span></div>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">Skor</div>
                        <div class="stat-value" id="final-score">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">En Ä°yi</div>
                        <div class="stat-value gold" id="best-score">0</div>
                    </div>
                </div>
                <button class="btn-gold" id="btn-retry"><span>TEKRAR DENE</span></button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• BACKGROUND MUSIC â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <audio id="bgMusic" loop>
        <source src="mÃ¼zik.mp3" type="audio/mpeg">
    </audio>

    <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HAFIZ HAVADA â€” RAMADAN EDITION
       Production Refactor â€” Senior Engineer Build
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    'use strict';

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CONFIGURATION â€” All magic numbers live here
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const CONFIG = Object.freeze({
        // Physics
        GRAVITY:           0.07,
        LIFT:             -3.6,
        MAX_FALL_SPEED:    8.0,
        ROTATION_FACTOR:   3.5,   // degrees per unit velocity
        MAX_ROTATION_UP:  -45,    // deg (nose up)
        MAX_ROTATION_DOWN:  25,   // deg (nose down)

        // World
        GAME_SPEED:        2.0,
        BG_PARALLAX_SPEED: 0.5,

        // Pipes
        PIPE_SPAWN_DIST:   360,   // px between pipe leading edges
        PIPE_GAP:          200,   // vertical gap between top & bottom pipe
        PIPE_WIDTH:         85,
        PIPE_MIN_TOP:      100,   // min height for top pipe
        PIPE_MAX_BOTTOM_CLEAR: 100, // pixels of clear space above the floor

        // Bird â€” large & chunky, clearly visible
        BIRD_W: 85,
        BIRD_H: 65,
        BIRD_START_X: 110,
        BIRD_HITBOX_SHRINK: 13,   // px inset on each side for forgiving hitbox

        // Camera shake
        SHAKE_FRAMES:  22,
        SHAKE_MAG:      9,

        // Assets
        ASSETS: {
            bg:   'rt.png',
            bird: 'dragon.png',
            pipe: 'br.png',
        }
    });

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ASSET LOADER â€” Promise-based, no race conditions
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const AssetLoader = {
        /**
         * Load a list of {key, src} image descriptors.
         * Returns a Promise<Map<key, HTMLImageElement>>.
         * Progress callback receives 0.0â€“1.0.
         */
        load(manifest, onProgress) {
            const map = new Map();
            let loaded = 0;

            const promises = manifest.map(({ key, src }) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        map.set(key, img);
                        loaded++;
                        if (onProgress) onProgress(loaded / manifest.length);
                        resolve();
                    };
                    img.onerror = () => {
                        // Non-fatal: store null, game uses canvas fallbacks
                        map.set(key, null);
                        loaded++;
                        if (onProgress) onProgress(loaded / manifest.length);
                        resolve(); // resolve, not reject â€” graceful degradation
                    };
                    img.src = src;
                });
            });

            return Promise.all(promises).then(() => map);
        }
    };

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       UTILITY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const Utils = {
        clamp: (val, min, max) => Math.max(min, Math.min(max, val)),
        randInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    };

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       MAIN GAME CLASS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    class HafizHavada {
        constructor(canvas) {
            this.canvas  = canvas;
            this.ctx     = canvas.getContext('2d', { alpha: false });
            this.sprites = new Map();  // populated by AssetLoader
            this.state   = 'MENU';    // MENU | PLAYING | GAMEOVER
            this.score   = 0;
            this.highScore = parseInt(localStorage.getItem('hafiz_hs') || '0', 10);
            this.shakeTick = 0;

            // Sub-systems
            this.background = new Background(this);
            this.bird       = new Bird(this);
            this.pipes      = new PipeManager(this);

            this._bindEvents();
            this._resizeCanvas();
            window.addEventListener('resize', () => this._resizeCanvas());
        }

        /* â”€â”€ Resize â”€â”€ */
        _resizeCanvas() {
            this.canvas.width  = window.innerWidth;
            this.canvas.height = window.innerHeight;
            // Re-centre bird on resize
            this.bird.groundY = this.canvas.height;
        }

        /* â”€â”€ Input â”€â”€ */
        _bindEvents() {
            const onInput = (e) => {
                if (e.type === 'touchstart') e.preventDefault();
                this._handleInput();
            };
            window.addEventListener('keydown',    (e) => { if (e.code === 'Space') { e.preventDefault(); this._handleInput(); } });
            window.addEventListener('touchstart', onInput, { passive: false });
            window.addEventListener('mousedown',  onInput);

            document.getElementById('btn-start').addEventListener('click',  () => this.startGame());
            document.getElementById('btn-retry').addEventListener('click',  () => this.startGame());
        }

        _handleInput() {
            if (this.state === 'PLAYING') {
                this.bird.flap();
            }
        }

        /* â”€â”€ State Transitions â”€â”€ */
        startGame() {
            this._hideAllScreens();
            document.getElementById('hud-score').style.display = 'block';

            const music = document.getElementById('bgMusic');
            if (music) music.play().catch(() => {});

            this.score     = 0;
            this.shakeTick = 0;
            this.bird.reset();
            this.pipes.reset();
            this._updateHUD();

            this.state = 'PLAYING';
        }

        triggerGameOver() {
            if (this.state === 'GAMEOVER') return;
            this.state     = 'GAMEOVER';
            this.shakeTick = CONFIG.SHAKE_FRAMES;

            if (this.score > this.highScore) {
                this.highScore = this.score;
                localStorage.setItem('hafiz_hs', this.highScore);
            }

            document.getElementById('final-score').textContent = this.score;
            document.getElementById('best-score').textContent  = this.highScore;
            document.getElementById('hud-score').style.display = 'none';

            // Small delay so the shake plays before the panel appears
            setTimeout(() => {
                document.getElementById('screen-gameover').classList.remove('hidden');
            }, 350);
        }

        addScore() {
            this.score++;
            this._updateHUD();
        }

        _updateHUD() {
            document.getElementById('hud-score').textContent = this.score;
        }

        _hideAllScreens() {
            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-gameover').classList.add('hidden');
        }

        /* â”€â”€ Camera Shake â”€â”€ */
        _applyShake() {
            if (this.shakeTick > 0) {
                const mag = CONFIG.SHAKE_MAG * (this.shakeTick / CONFIG.SHAKE_FRAMES);
                this.ctx.translate(
                    (Math.random() - 0.5) * mag,
                    (Math.random() - 0.5) * mag
                );
                this.shakeTick--;
            }
        }

        /* â”€â”€ Main Loop â”€â”€ */
        tick() {
            const { ctx, canvas } = this;

            // 1. Update
            if (this.state === 'PLAYING') {
                this.bird.update();
                this.pipes.update();
            }

            // 2. Render â€” wrap in save/restore for shake
            ctx.save();
            this._applyShake();

            this.background.draw();
            this.pipes.draw();

            if (this.state !== 'MENU') {
                this.bird.draw();
            } else {
                // Idle bob in menu
                this.bird.drawIdle();
            }

            ctx.restore();

            requestAnimationFrame(() => this.tick());
        }

        /** Called by AssetLoader after everything is ready */
        init(sprites) {
            this.sprites = sprites;

            // Hide loader with a fade
            const loader = document.getElementById('loader');
            loader.classList.add('fade-out');
            setTimeout(() => loader.classList.add('hidden'), 520);

            // Show menu
            document.getElementById('screen-menu').classList.remove('hidden');

            // Start loop
            this.tick();
        }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       BACKGROUND
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    class Background {
        constructor(game) {
            this.game   = game;
            this.scrollX = 0;
        }

        draw() {
            const { ctx, canvas, sprites, state } = this.game;
            const img = sprites.get('bg');

            if (img) {
                // Two-panel seamless scroll
                ctx.drawImage(img, this.scrollX,                 0, canvas.width, canvas.height);
                ctx.drawImage(img, this.scrollX + canvas.width,  0, canvas.width, canvas.height);

                if (state === 'PLAYING') {
                    this.scrollX -= CONFIG.BG_PARALLAX_SPEED;
                    if (this.scrollX <= -canvas.width) this.scrollX = 0;
                }
            } else {
                // Fallback gradient sky
                const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, '#1a237e');
                grad.addColorStop(0.4, '#283593');
                grad.addColorStop(1, '#1565c0');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       BIRD
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    class Bird {
        constructor(game) {
            this.game     = game;
            this.w        = CONFIG.BIRD_W;
            this.h        = CONFIG.BIRD_H;
            this.groundY  = game.canvas.height; // updated on resize
            this.reset();
        }

        reset() {
            const { canvas } = this.game;
            this.x        = CONFIG.BIRD_START_X;
            this.y        = canvas.height / 2;
            this.velocity = 0;
            this.rotation = 0;   // degrees
        }

        flap() {
            this.velocity = CONFIG.LIFT;
        }

        update() {
            const { canvas } = this.game;

            // Physics
            this.velocity += CONFIG.GRAVITY;
            this.velocity  = Utils.clamp(this.velocity, CONFIG.LIFT, CONFIG.MAX_FALL_SPEED);
            this.y        += this.velocity;

            // Visual rotation â€” smooth follow of velocity
            const targetRot = this.velocity * CONFIG.ROTATION_FACTOR;
            this.rotation = Utils.clamp(
                targetRot,
                CONFIG.MAX_ROTATION_UP,
                CONFIG.MAX_ROTATION_DOWN
            );

            // Floor collision
            if (this.y + this.h >= canvas.height) {
                this.y = canvas.height - this.h;
                this.game.triggerGameOver();
            }

            // Ceiling clamp (not game-over, just stop)
            if (this.y < 0) {
                this.y = 0;
                this.velocity = 0;
            }
        }

        /* Hit-box used for pipe collision â€” smaller than sprite */
        get hitbox() {
            const s = CONFIG.BIRD_HITBOX_SHRINK;
            return {
                x: this.x + s,
                y: this.y + s,
                w: this.w - s * 2,
                h: this.h - s * 2,
            };
        }

        draw() {
            this._renderAt(this.x, this.y, this.rotation);
        }

        /** Idle sinusoidal bob for menu screen */
        drawIdle() {
            const bobY = Math.sin(Date.now() / 320) * 14;
            this._renderAt(this.x, this.game.canvas.height / 2 + bobY, 0);
        }

        _renderAt(x, y, rotDeg) {
            const { ctx, sprites } = this.game;
            const img = sprites.get('bird');

            ctx.save();
            ctx.translate(x + this.w / 2, y + this.h / 2);
            ctx.rotate(rotDeg * Math.PI / 180);

            if (img) {
                ctx.drawImage(img, -this.w / 2, -this.h / 2, this.w, this.h);
            } else {
                // Fallback capsule
                ctx.fillStyle = '#FF8C00';
                ctx.beginPath();
                ctx.ellipse(0, 0, this.w / 2, this.h / 2, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(6, -4, 6, 5, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PIPE MANAGER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    class PipeManager {
        constructor(game) {
            this.game  = game;
            this.pipes = [];
        }

        reset() { this.pipes = []; }

        _spawnPipe() {
            const { canvas } = this.game;
            const maxTop = canvas.height - CONFIG.PIPE_GAP - CONFIG.PIPE_MAX_BOTTOM_CLEAR;
            const topH   = Utils.randInt(CONFIG.PIPE_MIN_TOP, maxTop);
            this.pipes.push({ x: canvas.width, topH, scored: false });
        }

        update() {
            const { canvas, bird } = this.game;
            const lastPipe = this.pipes[this.pipes.length - 1];

            // Spawn logic: fixed distance between leading edges
            if (!lastPipe || (canvas.width - lastPipe.x) >= CONFIG.PIPE_SPAWN_DIST) {
                this._spawnPipe();
            }

            for (let i = this.pipes.length - 1; i >= 0; i--) {
                const p = this.pipes[i];
                p.x -= CONFIG.GAME_SPEED;

                // â”€ Scoring â”€
                if (!p.scored && p.x + CONFIG.PIPE_WIDTH < bird.x) {
                    p.scored = true;
                    this.game.addScore();
                }

                // â”€ Collision â”€
                const hb = bird.hitbox;
                const pRight  = p.x + CONFIG.PIPE_WIDTH;
                const pBottom = p.topH + CONFIG.PIPE_GAP;
                const overlapX = hb.x < pRight && hb.x + hb.w > p.x;

                if (overlapX) {
                    const hitTop    = hb.y              < p.topH;
                    const hitBottom = hb.y + hb.h       > pBottom;
                    if (hitTop || hitBottom) {
                        this.game.triggerGameOver();
                    }
                }

                // â”€ Cleanup â”€
                if (p.x + CONFIG.PIPE_WIDTH < -10) {
                    this.pipes.splice(i, 1);
                }
            }
        }

        draw() {
            for (const p of this.pipes) {
                this._drawPipe(p);
            }
        }

        /**
         * _drawPipe â€” renders one top+bottom pipe pair using br.png.
         *
         * â•â•â• TOP PIPE (VERTICALLY FLIPPED) â•â•â•
         *
         *  Goal: br.png has its "mouth/cap" at the TOP of the image.
         *        For the top pipe we need the cap at the BOTTOM (facing down
         *        into the gap), so we flip the image vertically.
         *
         *  The top pipe must visually fill the region:
         *      y = 0  â†’  y = p.topH   (screen top down to the gap opening)
         *
         *  Technique â€” three canvas ops before drawImage:
         *    1. ctx.save()
         *    2. ctx.translate(p.x, p.topH)
         *       â†³ Moves the origin to the BOTTOM-LEFT corner of the top pipe.
         *    3. ctx.scale(1, -1)
         *       â†³ Flips Y axis. Now drawing at y=0 goes toward screen-top,
         *         and drawing at y=+H goes toward screen-bottom in real coords.
         *    4. ctx.drawImage(img, 0, 0, W, p.topH)
         *       â†³ In flipped space: the image draws FROM our origin UPWARD,
         *         spanning exactly p.topH pixels (fills screen top to gap).
         *         The cap (top of image) ends up at y=0 on screen.
         *         The shaft fills down to p.topH. âœ“
         *    5. ctx.restore()
         *
         * â•â•â• BOTTOM PIPE (NORMAL) â•â•â•
         *
         *  No transform needed. Draw from (p.x, p.topH + GAP) downward,
         *  height = canvas.height - bottomY to always fill to screen edge.
         *  The cap (top of image) sits right at the gap opening. âœ“
         */
        _drawPipe(p) {
            const { ctx, sprites, canvas } = this.game;
            const img     = sprites.get('pipe');
            const W       = CONFIG.PIPE_WIDTH;
            const GAP     = CONFIG.PIPE_GAP;
            const bottomY = p.topH + GAP;
            const botH    = canvas.height - bottomY; // fills to screen edge

            if (img) {
                // â”€â”€ TOP PIPE: flipped, cap faces DOWN into the gap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                ctx.save();
                ctx.translate(p.x, p.topH); // origin = bottom-left of top pipe
                ctx.scale(1, -1);            // flip Y axis
                // Draw with height = p.topH so it fills from screen-top to gap
                ctx.drawImage(img, 0, 0, W, p.topH);
                ctx.restore();

                // â”€â”€ BOTTOM PIPE: normal, cap faces UP into the gap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                ctx.drawImage(img, p.x, bottomY, W, botH > 0 ? botH : 0);

            } else {
                // â”€â”€ Fallback: colored rectangles when br.png fails to load â”€â”€

                // Top pipe body
                ctx.fillStyle = '#33691E';
                ctx.fillRect(p.x, 0, W, p.topH);
                // Top pipe cap (at the bottom of the top pipe = the "mouth")
                ctx.fillStyle = '#1B5E20';
                ctx.fillRect(p.x - 6, p.topH - 28, W + 12, 28);

                // Bottom pipe body
                ctx.fillStyle = '#33691E';
                ctx.fillRect(p.x, bottomY, W, botH);
                // Bottom pipe cap (at the top of the bottom pipe = the "mouth")
                ctx.fillStyle = '#1B5E20';
                ctx.fillRect(p.x - 6, bottomY, W + 12, 28);
            }
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BOOTSTRAP â€” Wait for DOM + Assets, then launch
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    window.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('gameCanvas');
        const game   = new HafizHavada(canvas);
        const bar    = document.getElementById('loader-bar');

        const manifest = [
            { key: 'bg',   src: CONFIG.ASSETS.bg   },
            { key: 'bird', src: CONFIG.ASSETS.bird  },
            { key: 'pipe', src: CONFIG.ASSETS.pipe  },
        ];

        AssetLoader.load(manifest, (progress) => {
            bar.style.width = (progress * 100) + '%';
        }).then((sprites) => {
            game.init(sprites);
        });
    });
    </script>
</body>
</html>